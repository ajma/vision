@{
    ViewBag.Title = "Search";
}

<script type="text/javascript">
    var searchResults;
    var selectedGlasses;
    var selectedIndex;

    $(document).ready(function () {
        $('input.sph').rxForm({ autoZero: false });
        $('input.cyl').rxForm({ autoZero: false, min: -20, max: 0 });
        $('input.axis').rxForm({ autoZero: false, min: 0, max: 180, littleStep: 5, bigStep: 10, beforeDecimal: 3, afterDecimal: 0, autoDecimal: 999 });
        $('input.add').rxForm({ autoZero: false, min: 0, max: 20 });

        $('#searchby a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });

        $('#searchButton').click(function () {
            $("#searchResults tbody").empty();

            var selectedTab = $('#searchby li.active a').attr('href');
            var url = (selectedTab === '#search_by_rx') ? '/Glasses/SearchByRx' : '/Glasses/SearchByCallNumber';
            var query = $(selectedTab + ' input').serializeArray()
            $.post(url, query, function (data) {
                $('#searchResultRow').tmpl(data).prependTo('#searchResults tbody');
                searchResults = $.isArray(data) ? data : [data];
            });
        });

        $('#clearButton').click(function () {
            $('.rx_form input[type=text]').each(function (index) { this.value = ''; });
            $('.rx_form input[type=checkbox]').each(function (index) { this.checked = false; });
            $("#searchResults tbody").empty();
        });

        $('.searchResultRow').live('click', function (event) {
            selectedIndex = $('#searchResults tbody tr').index(this);
            selectedGlasses = searchResults[selectedIndex].Glasses;
            $('#selectedModalTitle').text('Glasses ' + selectedGlasses.Group + '/' + selectedGlasses.Number);
            $('#selectedModal').html($('#selectedModalTemplate').tmpl(selectedGlasses));
            $('#selectedModal').modal().find('#removeFromInventory').click(removeSelectedGlasses);
        });
    });

    var removeSelectedGlasses = function () {
        var data = { group: selectedGlasses.Group, number: selectedGlasses.Number };
        $.post('/Glasses/Remove', data, function () {
            $('#searchResults tbody tr:nth-child(' + (selectedIndex + 1) + ')').remove();
            searchResults.splice(selectedIndex, 1);
            $('#selectedModal').modal('hide');
        });
    };
</script>

<h1>Search</h1>

<div id="searchForm">
    <div class="row-fluid">
        <div class="span12">
            <ul id="searchby" class="nav nav-tabs">
                <li class="active"><a href="#search_by_rx" data-toggle="tab">Search By Rx</a></li>
                <li><a href="#search_by_callnum" data-toggle="tab">Search By Call Number</a></li>
            </ul>
        </div>
    </div>
    <div class="tab-content">
        <div id="search_by_rx" class="row-fluid tab-pane active">
            <div class="span12">
                @Html.Partial("_RxForm")
            </div>
        </div>
        <div id="search_by_callnum" class="row-fluid tab-pane">
            <div class="span12">
                <div class="rx_form">
                    <div>Group:</div>
                    <div><input name="Group" type="text" /></div>
                    <div>Number:</div>
                    <div><input name="Number" type="text" /></div>
                </div>​

            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12 new-row">
            <button id="searchButton" class="btn btn-large btn-success"><i class="icon-search icon-white"></i> Search</button>
            <button id="clearButton" class="btn btn-large">Clear</button>
            <span id="searchingMessage" class="hide"><img src="/img/spinner.gif" alt="Searching..." /> <strong>Searching...</strong></span>
            <hr />
        </div>
        
    </div>
</div>

<script id="searchResultRow" type="text/x-jquery-tmpl">
    <tr class="searchResultRow">
        <td>${Score}</td>
        <td>${Glasses.Group}/${Glasses.Number}</td>
        <td class="table-horizontal-break">${sphcylFormat(Glasses.OD_Spherical)}</td>
        {{if Glasses.OD_Cylindrical === 0 && Glasses.OD_Axis === 0 && Glasses.OD_Add === 0}}
        <td colspan="3">DS</td>
        {{else}}
        <td>${sphcylFormat(Glasses.OD_Cylindrical)}</td>
        <td>${axisFormat(Glasses.OD_Axis)}</td>
        <td>${sphcylFormat(Glasses.OD_Add)}</td>
        {{/if}}
        <td class="table-horizontal-break">${sphcylFormat(Glasses.OS_Spherical)}</td>
        {{if Glasses.OD_Cylindrical === 0 && Glasses.OD_Axis === 0 && Glasses.OD_Add === 0}}
        <td colspan="3">DS</td>
        {{else}}
        <td>${sphcylFormat(Glasses.OS_Cylindrical)}</td>
        <td>${axisFormat(Glasses.OS_Axis)}</td>
        <td>${sphcylFormat(Glasses.OS_Add)}</td>
        {{/if}}
        <td class="table-horizontal-break">${Glasses.Sunglasses?'Yes':'No'}</td>
        <td>${Glasses.Gender}</td>
        <td>${Glasses.Size}</td>
    </tr>
</script>
<table id="searchResults" class="table table-striped table-bordered table-condensed">
    <thead>
    <tr>
        <th>Score</th>
        <th>Call #</th>
        <th>OD Sph</th>
        <th>OD Cyl</th>
        <th>OD Axis</th>
        <th>OD Add</th>
        <th>OS Sph</th>
        <th>OS Cyl</th>
        <th>OS Axis</th>
        <th>OS Add</th>
        <th>Sungl.</th>
        <th>Gender</th>
        <th>Size</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<div id="selectedModal" class="modal hide fade in">
</div>
<script id="selectedModalTemplate" type="text/x-jquery-tmpl">
    <div class="modal-header">
        <h3>Glasses ${Group}/${Number}</h3>
    </div>
    <div class="modal-body">
        <table class="table table-bordered table-condensed">
        <thead>
            <tr>
                <th></th>
                <th>Spherical</th>
                <th>Cylindrical</th>
                <th>Axis</th>
                <th>Add</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>OD (right):</th>
                <td>${sphcylFormat(OD_Spherical)}</td>
                {{if OD_Cylindrical === 0 && OD_Axis === 0 && OD_Add === 0}}
                <td colspan="3">DS</td>
                {{else}}
                <td>${sphcylFormat(OD_Cylindrical)}</td>
                <td>${axisFormat(OD_Axis)}</td>
                <td>${sphcylFormat(OD_Add)}</td>
                {{/if}}
            </tr>
            <tr>
                <th>OS (left):</th>
                <td>${sphcylFormat(OS_Spherical)}</td>
                {{if OS_Cylindrical === 0 && OS_Axis === 0 && OS_Add === 0}}
                <td colspan="3">DS</td>
                {{else}}
                <td>${sphcylFormat(OS_Cylindrical)}</td>
                <td>${axisFormat(OS_Axis)}</td>
                <td>${sphcylFormat(OS_Add)}</td>
                {{/if}}
            </tr>
        </tbody>
        </table>
        {{if Sunglasses}}
        <div>Sunglasses: ${Sunglasses?'Yes':'No'}</div>
        {{/if}}
        {{if Gender}}
        <div>Gender: <td>${Gender}</td></div>
        {{/if}}
        {{if Size}}
        <div>Size: ${Size}</div>
        {{/if}}
        <hr />
        <div>
            <a href="#" id="removeFromInventory" class="btn btn-large btn-warning">Remove from inventory</a>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</script>